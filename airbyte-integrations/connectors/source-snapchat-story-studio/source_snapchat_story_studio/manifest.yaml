version: "0.29.0"

definitions:
  selector:
    type: RecordSelector
    extractor:
      type: DpathExtractor
      field_path: []
  requester:
    type: HttpRequester
    url_base: "https://api.snapkit.com/v1/stories/studio"
    http_method: "GET"
    authenticator:
      type: "OAuthAuthenticator"
      token_refresh_endpoint: "https://accounts.snapchat.com/login/oauth2/access_token"
      client_id: "{{ config['client_id'] }}"
      client_secret: "{{ config['client_secret'] }}"
      refresh_token: "{{ config['refresh_token'] }}"
  retriever:
    type: SimpleRetriever
    record_selector:
      $ref: "#/definitions/selector"
    paginator:
      type: NoPagination
    requester:
      $ref: "#/definitions/requester"

  base_stream:
    type: DeclarativeStream
    retriever:
      $ref: "#/definitions/retriever"

  # Streams
  publishers_stream:
    $ref: "#/definitions/base_stream"
    name: "publishers"
    primary_key: "id"
    $parameters:
      path: "/publishers"

  # Analytics
  daily_audience_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - type: ParentStreamConfig
            stream: "#/definitions/publishers_stream"
            parent_key: id
            partition_field: id
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          fromDate: "{{ config['start_date'] }}"
          toDate: "{{ now_utc().strftime('%Y-%m-%d') }}"
    $parameters:
      name: "daily_audience"
      primary_key: "id"
      path: "analytics/publisher/{{ stream_slice.id }}/daily/audience"
    transformations:
      - type: AddFields
        fields:
          - path: ["publisher_id"]
            value: "{{ stream_slice.id }}"

  daily_behavior_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - type: ParentStreamConfig
            stream: "#/definitions/publishers_stream"
            parent_key: id
            partition_field: id
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          fromDate: "{{ config['start_date'] }}"
          toDate: "{{ now_utc().strftime('%Y-%m-%d') }}"
    $parameters:
      name: "daily_behavior"
      primary_key: "id"
      path: "analytics/publisher/{{ stream_slice.id }}/daily/behavior"
    transformations:
      - type: AddFields
        fields:
          - path: ["publisher_id"]
            value: "{{ stream_slice.id }}"

  stories_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      record_selector:
        extractor:
          type: DpathExtractor
          field_path: ["GLOBAL"]
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - type: ParentStreamConfig
            stream: "#/definitions/publishers_stream"
            parent_key: id
            partition_field: id
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          fromDate: "{{ config['start_date'] }}"
          toDate: "{{ now_utc().strftime('%Y-%m-%d') }}"
    $parameters:
      name: "stories"
      primary_key: "id"
      path: "analytics/publisher/{{ stream_slice.id }}/stories"
    transformations:
      - type: AddFields
        fields:
          - path: ["publisher_id"]
            value: "{{ stream_slice.id }}"

  revenue_editions_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - type: ParentStreamConfig
            stream: "#/definitions/publishers_stream"
            parent_key: id
            partition_field: id
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          start_date: "{{ config['start_date'] }}"
          end_date: "{{ now_utc().strftime('%Y-%m-%d') }}"
    $parameters:
      name: "revenue_editions"
      primary_key: "id"
      path: "revenue/publisher/{{ stream_slice.id }}/editions"
    transformations:
      - type: AddFields
        fields:
          - path: ["publisher_id"]
            value: "{{ stream_slice.id }}"

  revenue_aggregate_stream:
    $ref: "#/definitions/base_stream"
    retriever:
      $ref: "#/definitions/retriever"
      partition_router:
        type: SubstreamPartitionRouter
        parent_stream_configs:
          - type: ParentStreamConfig
            stream: "#/definitions/publishers_stream"
            parent_key: id
            partition_field: id
      requester:
        $ref: "#/definitions/requester"
        request_parameters:
          start_date: "{{ config['start_date'] }}"
          end_date: "{{ now_utc().strftime('%Y-%m-%d') }}"
    $parameters:
      name: "revenue_aggregate"
      primary_key: "id"
      path: "revenue/publisher/{{ stream_slice.id }}/aggregate"
    transformations:
      - type: AddFields
        fields:
          - path: ["publisher_id"]
            value: "{{ stream_slice.id }}"

streams:
  - "#/definitions/publishers_stream"
  - "#/definitions/daily_audience_stream"
  - "#/definitions/daily_behavior_stream"
  - "#/definitions/stories_stream"
  - "#/definitions/revenue_editions_stream"
  - "#/definitions/revenue_aggregate_stream"

check:
  type: CheckStream
  stream_names:
    - "publishers"

spec:
  type: Spec
  documentation_url: https://docs.airbyte.com/integrations/sources/snapchat-story-studio
  connection_specification:
    title: Snapchat Story Studio Spec
    type: object
    required:
      - client_id
      - client_secret
      - refresh_token
      - start_date
    additionalProperties: true
    properties:
      client_id:
        title: Client ID
        order: 1
        type: string
        description: OAuth Client ID
        airbyte_secret: true
      client_secret:
        title: Client Secret
        order: 2
        type: string
        description: OAuth Client Secret
        airbyte_secret: true
      refresh_token:
        title: Refresh Token
        order: 3
        type: string
        description: OAuth Refresh Token
        airbyte_secret: true
      start_date:
        title: Start Date
        order: 4
        type: string
        description: The Start date for collecting reports, in YYYY-MM-DD format.
        examples:
          - "2022-10-10"
          - "2022-10-22"
